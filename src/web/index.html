<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager GUI</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden relative">

    <!-- TOP ALARM CONTAINER -->
    <div id="alarm-container" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none">
        <!-- Alarms will be injected here -->
    </div>

    <div class="flex h-full">
        
        <!-- LEFT PANEL: DASHBOARD (Observer View) -->
        <div class="w-2/3 p-6 overflow-y-auto" id="dashboard-panel">
            <header class="mb-8">
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="layout-dashboard" class="text-blue-600"></i>
                    Inventory Dashboard
                </h1>
                <p class="text-gray-500 mt-1">Real-time view of composite product structure.</p>
            </header>

            <!-- Container for Categories -->
            <div id="inventory-list" class="space-y-4"></div>
        </div>

        <!-- RIGHT PANEL: MANAGER CONTROLS (Invoker) -->
        <div class="w-1/3 bg-white border-l border-gray-200 flex flex-col shadow-xl z-10">
            
            <!-- Header -->
            <div class="p-6 border-b border-gray-100 bg-slate-50">
                <h2 class="text-lg font-bold flex items-center gap-2 text-slate-700">
                    <i data-lucide="settings" size="20"></i>
                    Manager Controls
                </h2>
            </div>

            <!-- Selected Product Actions -->
            <div class="p-6 flex-1 overflow-y-auto relative" id="control-panel">
                <!-- Content injected via JS -->
                <div id="empty-state" class="py-12 flex flex-col items-center justify-center text-gray-400 text-center p-4">
                    <i data-lucide="shopping-cart" size="48" class="mb-4 opacity-20"></i>
                    <p>Select a product from the dashboard to manage inventory.</p>
                </div>

                <div id="active-state" class="hidden animate-fade-in">
                    <!-- Dynamic Product Details -->
                    <div id="product-card" class="p-4 rounded-xl border-2 mb-6 transition-colors duration-300">
                        <div class="flex justify-between items-start mb-2">
                            <h3 id="detail-name" class="font-bold text-lg">Product Name</h3>
                            <span id="detail-badge" class="px-2 py-1 rounded text-xs font-bold">State</span>
                        </div>
                        <div id="detail-qty" class="text-3xl font-bold text-slate-700 mb-1">0</div>
                        <div class="text-xs text-slate-400 uppercase font-semibold">Current Stock Level</div>
                    </div>

                    <!-- Buttons -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Add Stock Section -->
                        <div class="flex flex-col gap-2">
                            <input type="number" id="add-stock-amount" value="1" min="1" class="p-2 border border-gray-300 rounded-lg text-sm text-center" placeholder="Qty">
                            <button onclick="app.executeCommand('ADD_STOCK', document.getElementById('add-stock-amount').value)" class="flex items-center justify-center gap-2 p-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-lg shadow-green-200 transition-all active:scale-95">
                                <i data-lucide="plus" size="20"></i>
                                <span>Add</span>
                            </button>
                        </div>
                        
                        <!-- Sell Section -->
                        <div class="flex flex-col gap-2">
                            <input type="number" id="sell-stock-amount" value="1" min="1" class="p-2 border border-gray-300 rounded-lg text-sm text-center" placeholder="Qty">
                            <button onclick="app.executeCommand('REMOVE_STOCK', document.getElementById('sell-stock-amount').value)" class="flex items-center justify-center gap-2 p-3 bg-red-500 hover:bg-red-600 text-white rounded-xl shadow-lg shadow-red-200 transition-all active:scale-95">
                                <i data-lucide="minus" size="20"></i>
                                <span>Sell</span>
                            </button>
                        </div>
                    </div>
                    <button onclick="app.deleteProduct()" class="w-full flex items-center justify-center gap-2 p-3 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl transition-all active:scale-95 mb-8">
                        <i data-lucide="trash-2" size="18"></i>
                        <span>Delete Product</span>
                    </button>
                </div>

                <!-- Standalone Sections -->
                <div class="px-4 pb-6">
                    <!-- Tabs Navigation -->
                    <div class="flex border-b border-gray-200 mb-4">
                        <button onclick="app.switchTab('product')" id="tab-product" class="flex-1 py-2 text-xs font-bold text-blue-600 border-b-2 border-blue-600 focus:outline-none">Product</button>
                        <button onclick="app.switchTab('category')" id="tab-category" class="flex-1 py-2 text-xs font-bold text-gray-500 hover:text-gray-700 focus:outline-none">Category</button>
                        <button onclick="app.switchTab('type')" id="tab-type" class="flex-1 py-2 text-xs font-bold text-gray-500 hover:text-gray-700 focus:outline-none">Type</button>
                    </div>

                    <!-- Register Product Section -->
                    <div id="section-product" class="tab-content">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Register Product</h4>

                        <label class="block text-xs font-bold text-gray-500 mb-1">Product Type</label>
                        <select id="factory-selector" class="w-full p-2 border border-gray-300 rounded-lg mb-3 bg-white text-sm">
                            <option value="">Select Product Type</option>
                        </select>

                        <label class="block text-xs font-bold text-gray-500 mb-1">Product Category</label>
                        <select id="parent-category-selector" class="w-full p-2 border border-gray-300 rounded-lg mb-3 bg-white text-sm">
                            <option value="">Select Product Category</option>
                        </select>

                        <label class="block text-xs font-bold text-gray-500 mb-1">Name</label>
                        <input type="text" id="new-product-name" placeholder="Name" class="w-full p-2 border border-gray-300 rounded-lg mb-2 text-sm">
                        
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Price</label>
                                <input type="number" id="new-product-price" placeholder="Price" class="w-full p-2 border border-gray-300 rounded-lg text-sm" value="100">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Initial Stock</label>
                                <input type="number" id="new-product-stock" placeholder="Initial Stock" class="w-full p-2 border border-gray-300 rounded-lg text-sm" value="10">
                            </div>
                        </div>
                        
                        <label class="block text-xs font-bold text-gray-500 mb-1">Low Stock Threshold</label>
                        <input type="number" id="new-product-threshold" placeholder="Low Stock Threshold" class="w-full p-2 border border-gray-300 rounded-lg text-sm" value="5">

                        <div id="factory-specific-input" class="mt-2 mb-4">
                        </div>

                        <button onclick="app.createProduct()" class="w-full flex items-center justify-center gap-2 p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors active:scale-95 shadow-md">
                            <i data-lucide="plus-circle" size="16"></i>
                            <span>Create New Product</span>
                        </button>
                    </div>

                    <!-- Register Product Category Section -->
                    <div id="section-category" class="tab-content hidden">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Register Product Category</h4>

                        <label class="block text-xs font-bold text-gray-500 mb-1">Related Product Type</label>
                        <select id="cat-parent-type" class="w-full p-2 border border-gray-300 rounded-lg mb-3 text-sm bg-white">
                            <option value="">Select Parent Type</option>
                        </select>

                        <label class="block text-xs font-bold text-gray-500 mb-1">Category Name</label>
                        <input type="text" id="new-category-name" placeholder="Category Name" class="w-full p-2 border border-gray-300 rounded-lg mb-2 text-sm">

                        <button onclick="app.createCategory()" class="w-full flex items-center justify-center gap-2 p-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors active:scale-95 shadow-md mb-3">
                            <i data-lucide="folder-plus" size="16"></i>
                            <span>Register New Category</span>
                        </button>

                        <div class="flex gap-2">
                            <select id="delete-category-selector" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm">
                                <option value="">Select Category to Delete</option>
                            </select>
                            <button onclick="app.deleteCategory()" class="p-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg transition-colors active:scale-95">
                                <i data-lucide="trash-2" size="16"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Register Product Type Section -->
                    <div id="section-type" class="tab-content hidden">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Register Product Type</h4>

                        <label class="block text-xs font-bold text-gray-500 mb-1">Product Type Name</label>
                        <input type="text" id="new-product-type-name" placeholder="Product Type Name" class="w-full p-2 border border-gray-300 rounded-lg mb-2 text-sm">

                        <button onclick="app.registerProductType()" class="w-full flex items-center justify-center gap-2 p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors active:scale-95 shadow-md mb-3">
                            <i data-lucide="settings" size="16"></i>
                            <span>Register Product Type</span>
                        </button>

                        <div class="flex gap-2">
                            <select id="delete-type-selector" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm">
                                <option value="">Select Type to Delete</option>
                            </select>
                            <button onclick="app.deleteProductType()" class="p-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg transition-colors active:scale-95">
                                <i data-lucide="trash-2" size="16"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History & Logs -->
            <div class="h-1/3 border-t border-gray-200 bg-gray-50 flex flex-col">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white">
                    <h3 class="text-xs font-bold text-gray-500 uppercase flex items-center gap-2">
                        <i data-lucide="history" size="14"></i>
                        Command History
                    </h3>
                    <button id="undo-btn" onclick="app.undoLastCommand()" disabled class="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                        <i data-lucide="undo" size="12"></i>
                        Undo Last
                    </button>
                </div>
                <div id="log-container" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <p id="empty-log" class="text-xs text-center text-gray-400 mt-4 italic">No actions recorded yet.</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        class InventoryApp {
            constructor() {
                this.inventory = [];

                this.selectedProductId = null;
                this.commandHistory = [];
                this.notifications = [];
                this.productTypes = [];
                this.init();
            }

            async init() {
                await this.fetchInventory();
                this.setupFactoryListener();
                this.renderAll();
                lucide.createIcons();
            }

            async fetchInventory() {
                console.log("Fetch Inventory");
                try {
                    const response = await fetch('/api/inventory?t=' + Date.now());
                    this.inventory = await response.json();
                } catch (error) {
                    console.error('Error fetching inventory:', error);
                }
            }

            getProductState(quantity, threshold) {
                if (quantity === 0) return { name: 'OutOfStock', color: 'text-red-600', bg: 'bg-red-100', borderColor: 'border-red-100', cardBg: 'bg-red-50', icon: 'alert-triangle' };
                if (quantity <= threshold) return { name: 'LowStock', color: 'text-orange-600', bg: 'bg-orange-100', borderColor: 'border-blue-100', cardBg: 'bg-blue-50', icon: 'activity' };
                return { name: 'InStock', color: 'text-green-600', bg: 'bg-green-100', borderColor: 'border-blue-100', cardBg: 'bg-blue-50', icon: 'package' };
            }

            findProduct(id, list = this.inventory) {
                const items = Array.isArray(list) ? list : [list];

                for (const item of items) {
                    if (item.type === 'category') {
                        if (item.children) {
                            const found = this.findProduct(id, item.children);
                            if (found) return found;
                        }
                    } else if (String(item.id) === String(id)) {
                        return item;
                    }
                }
                return null;
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`section-${tabName}`).classList.remove('hidden');
                ['product', 'category', 'type'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    if (t === tabName) {
                        btn.className = 'flex-1 py-2 text-xs font-bold text-blue-600 border-b-2 border-blue-600 focus:outline-none';
                    } else {
                        btn.className = 'flex-1 py-2 text-xs font-bold text-gray-500 hover:text-gray-700 focus:outline-none';
                    }
                });
            }

            selectProduct(id) {
                this.selectedProductId = id;
                this.renderControls();
            }

            async executeCommand(type, amount) {
                if (!this.selectedProductId) return;

                const product = this.findProduct(this.selectedProductId);
                if (!product) return;

                const timestamp = new Date().toLocaleTimeString();

                if (type === 'REMOVE_STOCK' && product.quantity === 0) {
                    this.showAlarm('critical', `SALE FAILED: ${product.name} is Out of Stock.`);
                    this.renderLogs();
                    return;
                }

                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `product=${encodeURIComponent(product.name)}&type=${type === 'ADD_STOCK' ? 'restock' : 'buy'}&amount=${amount}`
                    });

                    if (response.ok) {
                        await this.fetchInventory();

                        const updatedProduct = this.findProduct(this.selectedProductId);
                        let msg = "";

                        if (type === 'ADD_STOCK') {
                            msg = `Stock increased for ${product.name} by ${amount}`;
                        } else if (type === 'REMOVE_STOCK') {
                            msg = `Stock reduced for ${product.name} by ${amount}`;
                            if (updatedProduct.quantity === 0) {
                                this.showAlarm('critical', `CRITICAL: ${product.name} is now OUT OF STOCK!`);
                            } else if (updatedProduct.quantity <= updatedProduct.threshold) {
                                this.showAlarm('warning', `WARNING: ${product.name} is running LOW (${updatedProduct.quantity} remaining)`);
                            }
                        }

                        this.commandHistory.unshift({
                            id: Date.now(),
                            type,
                            amount,
                            productId: product.id,
                            productName: product.name,
                            timestamp
                        });

                        this.notifications.unshift({ id: Date.now(), msg, time: timestamp });
                        this.renderAll();
                    }
                } catch (error) {
                    console.error('Error executing command:', error);
                }
            }

            async undoLastCommand() {
                if (this.commandHistory.length === 0) {
                    this.showAlarm('warning', 'Command History is empty. Nothing to undo.');
                    return;
                }
                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `type=undo`
                    });
                    const responseText = await response.text();
                    let result = { success: false, message: responseText };

                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        if (responseText.includes("status\":\"success\"")) {
                            result.success = true;
                            result.message = "Undo successful (Stock change expected).";
                        }
                    }

                    if (response.ok && result.status === "success") {
                        const undoneCommand = this.commandHistory.shift();

                        this.notifications.unshift({
                            id: Date.now(),
                            msg: `[UNDO] Last action (${undoneCommand.type}) reversed for ${undoneCommand.productName}.`,
                            time: new Date().toLocaleTimeString()
                        });

                        this.showAlarm('info', 'Last Command Successfully Undone. Inventory refreshed.');
                        await this.fetchInventory();
                        this.renderAll();
                    } else {
                        this.showAlarm('error', `Undo Failed: ${result.message || 'Server rejected the undo action.'}`);
                    }
                } catch (error) {
                    console.error('Error during undo command:', error);
                    this.showAlarm('error', `Network error during undo.`);
                }
            }

            showAlarm(type, message) {
                const container = document.getElementById('alarm-container');
                container.innerHTML = '';

                const el = document.createElement('div');
                const isCrit = type === 'critical';
                const bg = isCrit ? 'bg-red-600' : 'bg-orange-500';

                el.className = `flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl text-white ${bg} animate-slide-down pointer-events-auto mb-2`;
                el.innerHTML = `
                    <i data-lucide="alert-circle" class="animate-pulse"></i>
                    <span class="font-bold tracking-wide text-sm">${message}</span>
                    <button class="ml-2 hover:bg-white/20 rounded-full p-1 transition-colors" onclick="this.parentElement.remove()">
                        <i data-lucide="x" size="16"></i>
                    </button>
                `;

                container.appendChild(el);
                lucide.createIcons();

                setTimeout(() => {
                    if(el.parentElement) el.remove();
                }, 4000);
            }

            renderAll() {
                this.renderInventory();
                this.renderControls();
                this.renderLogs();
                this.renderCategorySelector();
                this.renderFactorySelector();
                lucide.createIcons();
            }

            renderInventory() {
                const container = document.getElementById('inventory-list');
                container.innerHTML = '';
                const items = Array.isArray(this.inventory) ? this.inventory : [this.inventory];

                items.forEach(cat => {
                    if (cat.type === 'category') {
                        container.innerHTML += this.renderCategoryHtml(cat, true);
                    }
                });
                lucide.createIcons();
            }

            renderCategoryHtml(cat, isRoot = false) {
                const catVal = this.calculateCategoryValue(cat);

                let childrenHtml = '';
                if (cat.children) {
                    childrenHtml = cat.children.map(child => {
                        if (child.type === 'category') {
                            return this.renderCategoryHtml(child, false);
                        } else {
                            return this.renderProductHtml(child);
                        }
                    }).join('');
                }

                if (isRoot) {
                    return `
                        <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200">
                                <h3 class="flex items-center gap-2 font-bold text-gray-700">
                                    <i data-lucide="archive" size="18"></i>
                                    ${cat.name}
                                </h3>
                                <span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded">
                                    Val: $${catVal.toLocaleString()}
                                </span>
                            </div>
                            <div class="pl-2 space-y-2">
                                ${childrenHtml}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="ml-4 mt-2 border-l-2 border-gray-200 pl-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-sm font-bold text-gray-600 flex items-center gap-2">
                                    <i data-lucide="folder" size="14"></i>
                                    ${cat.name}
                                </h4>
                                <span class="text-[10px] font-mono text-gray-400">Val: $${catVal.toLocaleString()}</span>
                            </div>
                            <div class="space-y-2">
                                ${childrenHtml}
                            </div>
                        </div>
                    `;
                }
            }

            renderProductHtml(prod) {
                const state = this.getProductState(prod.quantity, prod.threshold);
                return `
                    <div onclick="app.selectProduct('${prod.id}')"
                            class="flex items-center justify-between p-3 bg-white border border-gray-100 rounded-lg hover:bg-blue-50 cursor-pointer transition-all shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full ${state.bg} ${state.color}">
                                <i data-lucide="${state.icon}" size="16"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">${prod.name}</h4>
                                <p class="text-xs text-gray-500"> $${prod.price}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-bold ${state.color} block">
                                ${prod.quantity} units
                            </span>
                            <span class="text-xs text-gray-400 uppercase tracking-wider font-semibold">
                                ${state.name}
                            </span>
                        </div>
                    </div>
                `;
            }

            calculateCategoryValue(cat) {
                if (!cat.children) return 0;
                return cat.children.reduce((acc, child) => {
                    if (child.type === 'category') {
                        return acc + this.calculateCategoryValue(child);
                    } else {
                        return acc + (child.price * child.quantity);
                    }
                }, 0);
            }

            renderControls() {
                const empty = document.getElementById('empty-state');
                const active = document.getElementById('active-state');

                if (!this.selectedProductId) {
                    empty.style.display = 'flex';
                    active.style.display = 'none';
                    return;
                }

                const product = this.findProduct(this.selectedProductId);
                if (!product) return;

                empty.style.display = 'none';
                active.style.display = 'block';

                const state = this.getProductState(product.quantity, product.threshold);
                const card = document.getElementById('product-card');
                card.className = `p-4 rounded-xl border-2 mb-6 transition-colors duration-300 ${state.borderColor} ${state.cardBg}`;

                document.getElementById('detail-name').innerText = product.name;
                document.getElementById('detail-qty').innerText = product.quantity;

                const badge = document.getElementById('detail-badge');
                badge.className = `px-2 py-1 rounded text-xs font-bold ${state.bg} ${state.color}`;
                badge.innerText = state.name;
            }

            renderLogs() {
                const container = document.getElementById('log-container');
                const btn = document.getElementById('undo-btn');

                btn.disabled = this.commandHistory.length === 0;

                if (this.notifications.length === 0) {
                    container.innerHTML = '<p class="text-xs text-center text-gray-400 mt-4 italic">No actions recorded yet.</p>';
                    return;
                }

                container.innerHTML = this.notifications.map(n => `
                    <div class="text-xs p-2 bg-white rounded border border-gray-100 shadow-sm flex justify-between animate-slide-up mb-2">
                        <span class="text-gray-700">${n.msg}</span>
                        <span class="text-gray-400 font-mono">${n.time}</span>
                    </div>
                `).join('');
            }

            collectCategoryNames(list = this.inventory, names = []) {
                const items = Array.isArray(list) ? list : [list];
                for (const item of items) {
                    if (item.type === 'category') {
                        names.push(item.name);
                        if (item.children) {
                            this.collectCategoryNames(item.children, names);
                        }
                    }
                }
                return names;
            }

            renderCategorySelector() {
                const categories = this.collectCategoryNames();
                const prodSelector = document.getElementById('parent-category-selector');
                if (prodSelector && prodSelector.options.length <= 1) {
                     prodSelector.innerHTML = '<option value="">Select Product Type First</option>';
                }

                const delCatSelector = document.getElementById('delete-category-selector');
                if (delCatSelector) {
                    delCatSelector.innerHTML = '<option value="">Select Category to Delete</option>';
                    categories.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.innerText = name;
                        delCatSelector.appendChild(option);
                    });
                }
            }

            findCategoryNode(node, name) {
                if (!node) return null;
                if (node.type === 'category' && node.name === name) {
                    return node;
                }
                if (node.children) {
                    for (const child of node.children) {
                        const found = this.findCategoryNode(child, name);
                        if (found) return found;
                    }
                }
                return null;
            }

            updateProductCategorySelector(type) {
                const selector = document.getElementById('parent-category-selector');
                selector.innerHTML = '<option value="">Select Product Category</option>';
                
                if (!type) {
                    selector.innerHTML = '<option value="">Select Product Type First</option>';
                    return;
                }

                const typeCategoryNode = this.findCategoryNode(this.inventory, type);
                
                if (typeCategoryNode) {
                    const categories = this.collectCategoryNames(typeCategoryNode);
                    categories.forEach(name => {
                        if (name.toLowerCase() === type.toLowerCase()) return;

                        const option = document.createElement('option');
                        option.value = name;
                        option.innerText = name;
                        selector.appendChild(option);
                    });
                } else {
                     selector.innerHTML = '<option value="">No categories found for this type</option>';
                }
            }

            async fetchProductTypes() {
                try {
                    const response = await fetch('/api/product-types?t=' + Date.now());
                    if (response.ok) {
                        this.productTypes = await response.json();
                    } else {
                        console.error('API Error fetching product types:', response.status);
                        this.productTypes = ["Electronics", "Apparel"];
                    }
                } catch (error) {
                    console.error('Network or Parse Error fetching product types', error);
                }
            }

            renderFactorySelector() {
                const selector = document.getElementById('factory-selector');
                const delTypeSelector = document.getElementById('delete-type-selector');
                const catParentSelector = document.getElementById('cat-parent-type');

                selector.innerHTML = '<option value="">Select Product Type</option>';
                if (delTypeSelector) delTypeSelector.innerHTML = '<option value="">Select Type to Delete</option>';
                if (catParentSelector) catParentSelector.innerHTML = '<option value="">Select Related Product Type</option>';

                if(this.productTypes.length === 0){
                    this.productTypes = ["Electronics", "Apparel"];
                }
                this.productTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.innerText = type + ' Product';
                    selector.appendChild(option);

                    if (delTypeSelector) {
                        const delOption = document.createElement('option');
                        delOption.value = type;
                        delOption.innerText = type;
                        delTypeSelector.appendChild(delOption);
                    }

                    if (catParentSelector) {
                        const catOption = document.createElement('option');
                        catOption.value = type;
                        catOption.innerText = type;
                        catParentSelector.appendChild(catOption);
                    }
                });
                this.setupFactoryListener();
            }

            setupFactoryListener() {
                const selector = document.getElementById('factory-selector');
                selector.addEventListener('change', (e) => this.renderFactorySpecificInput(e.target.value));
            }

            renderFactorySpecificInput(productType) {
                this.updateProductCategorySelector(productType);
                const container = document.getElementById('factory-specific-input');
                container.innerHTML = '';

                let html = '';
                if (productType === 'Electronics') {
                    html = `
                        <input type="number" id="specific-warranty" placeholder="Warranty Months (e.g., 12)" class="w-full p-2 border border-gray-300 rounded-lg text-sm" value="12" required>
                    `;
                } else if (productType === 'Apparel') {
                    html = `
                        <input type="text" id="specific-size" placeholder="Size (e.g., M, XL)" class="w-full p-2 border border-gray-300 rounded-lg text-sm" value="L" required>
                    `;
                }
                container.innerHTML = html;
            }

            async createProduct() {
                const parentCategory = document.getElementById('parent-category-selector').value;
                const type = document.getElementById('factory-selector').value;
                const name = document.getElementById('new-product-name').value;

                const priceInput = document.getElementById('new-product-price');
                const stockInput = document.getElementById('new-product-stock');
                const thresholdInput = document.getElementById('new-product-threshold');

                const price = parseInt(priceInput.value);
                const stock = parseInt(stockInput.value);
                const threshold = parseInt(thresholdInput.value);

                if (!parentCategory || !type || !name || isNaN(price) || isNaN(stock) || isNaN(threshold)) {
                    this.showAlarm('error', 'Please ensure all Category, Type, Name, Price, Stock, and Threshold fields are valid numbers.');
                    return;
                }

                let specificParam = '';
                if (type === 'Electronics') {
                    specificParam = document.getElementById('specific-warranty').value;
                } else if (type === 'Apparel') {
                    specificParam = document.getElementById('specific-size').value;
                }

                const formData = new URLSearchParams();
                formData.append('type', 'create_product');
                formData.append('parentCategory', parentCategory);
                formData.append('productType', type);
                formData.append('name', name);
                formData.append('price', price.toString());
                formData.append('stock', stock.toString());
                formData.append('threshold', threshold.toString());
                formData.append('specificParam', specificParam);

                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });

                    const responseText = await response.text();
                    let result = { success: false, message: responseText };

                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        result.message = responseText.substring(0, 100) + '... (See console for full error)';
                    }

                    if (response.ok) {
                        if (result.status === 'success') {
                            this.showAlarm('info', `${name} created successfully using ${type} Factory.`);
                            await this.fetchInventory();
                            this.renderAll();
                        } else {
                            this.showAlarm('error', `Product creation failed: ${result.message || 'Server rejected the request (Logic Error).'}`);
                            console.error('Backend Logic Error:', result);
                        }
                    } else {
                        this.showAlarm('error', `Product creation failed. HTTP Status ${response.status}: ${result.message || 'Server returned an error status.'}`);
                        console.error('HTTP Error:', response.status, responseText);
                    }
                } catch (error) {
                    this.showAlarm('error', `Network error during product creation. Check Server Console.`);
                    console.error('Network/Client Error:', error);
                }
            }

            async createCategory() {
                const name = document.getElementById('new-category-name').value;
                const parentType = document.getElementById('cat-parent-type').value;

                if (!parentType) {
                    this.showAlarm('error', 'Please select a product Type.');
                    return;
                }

                if (!name) {
                    this.showAlarm('error', 'Please enter a Category Name.');
                    return;
                }

                if (!/^[a-zA-Z0-9\s-]+$/.test(name)) {
                    this.showAlarm('error', 'Category Name contains invalid characters. Only letters, numbers, spaces and hyphens are allowed.');
                    return;
                }

                const formData = new URLSearchParams();
                formData.append('type', 'create_category');
                formData.append('name', name);
                formData.append('parentName', parentType);

                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });

                    const responseText = await response.text();
                    let result = { success: false, message: responseText };

                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        result.message = responseText.substring(0, 100) + '...';
                    }

                    if (response.ok) {
                        if (result.status === 'success') {
                            this.showAlarm('info', `Category "${name}" created successfully.`);
                            await this.fetchInventory();
                            this.renderAll();
                            document.getElementById('new-category-name').value = '';
                        } else {
                            this.showAlarm('error', `Category creation failed: ${result.message}`);
                        }
                    } else {
                        this.showAlarm('error', `Category creation failed. HTTP Status ${response.status}`);
                    }
                } catch (error) {
                    this.showAlarm('error', `Network error during category creation.`);
                    console.error('Network/Client Error:', error);
                }
            }

            async registerProductType() {
                const typeName = document.getElementById('new-product-type-name').value;

                if (!typeName) {
                    this.showAlarm('error', 'Please enter a Product Type Name.');
                    return;
                }

                if (!/^[a-zA-Z0-9\s-]+$/.test(typeName)) {
                    this.showAlarm('error', 'Product Type Name contains invalid characters. Only letters, numbers, spaces, and hyphens are allowed.');
                    return;
                }

                const formData = new URLSearchParams();
                formData.append('type', 'register_product_type');
                formData.append('typeName', typeName);

                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });

                    const responseText = await response.text();
                    let result = { success: false, message: responseText };

                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        result.message = responseText.substring(0, 100) + '...';
                    }

                    if (response.ok) {
                        if (result.status === 'success') {
                            this.showAlarm('info', `Product Type "${typeName}" registered successfully.`);
                            await this.fetchProductTypes();
                            await this.fetchInventory();
                            this.renderAll();
                            document.getElementById('new-product-type-name').value = '';
                        } else {
                            this.showAlarm('error', `Registration failed: ${result.message}`);
                        }
                    } else {
                        this.showAlarm('error', `Registration failed. HTTP Status ${response.status}`);
                    }
                } catch (error) {
                    this.showAlarm('error', `Network error during registration.`);
                    console.error('Network/Client Error:', error);
                }
            }

            async deleteProduct() {
                if (!this.selectedProductId) return;
                const product = this.findProduct(this.selectedProductId);
                if (!product) return;

                if (!confirm(`Are you sure you want to delete product "${product.name}"?`)) return;

                const formData = new URLSearchParams();
                formData.append('type', 'remove_product');
                formData.append('product', product.name);

                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });
                    
                    if (response.ok) {
                        this.showAlarm('info', `Product "${product.name}" removed.`);
                        this.selectedProductId = null;
                        await this.fetchInventory();
                        this.renderAll();
                    } else {
                        this.showAlarm('error', 'Failed to remove product.');
                    }
                } catch (error) {
                    console.error(error);
                    this.showAlarm('error', 'Network error removing product.');
                }
            }

            async deleteCategory() {
                const name = document.getElementById('delete-category-selector').value;
                if (!name) {
                    this.showAlarm('error', 'Please select a category to remove.');
                    return;
                }

                if (!confirm(`Are you sure you want to delete category "${name}"?`)) return;

                const formData = new URLSearchParams();
                formData.append('type', 'remove_category');
                formData.append('name', name);

                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });
                    
                    if (response.ok) {
                        this.showAlarm('info', `Category "${name}" removed.`);
                        await this.fetchInventory();
                        this.renderAll();
                    } else {
                        const text = await response.text();
                        this.showAlarm('error', 'Failed to remove category: ' + text);
                    }
                } catch (error) {
                    console.error(error);
                    this.showAlarm('error', 'Network error removing category.');
                }
            }

            async deleteProductType() {
                const typeName = document.getElementById('delete-type-selector').value;
                if (!typeName) {
                    this.showAlarm('error', 'Please select a product type to remove.');
                    return;
                }

                if (!confirm(`Are you sure you want to delete product type "${typeName}"?`)) return;

                const formData = new URLSearchParams();
                formData.append('type', 'remove_product_type');
                formData.append('typeName', typeName);

                try {
                    const response = await fetch('/api/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });
                    
                    if (response.ok) {
                        this.showAlarm('info', `Product Type "${typeName}" removed.`);
                        await this.fetchProductTypes();
                        await this.fetchInventory();
                        this.renderAll();
                    } else {
                        this.showAlarm('error', 'Failed to remove product type.');
                    }
                } catch (error) {
                    console.error(error);
                    this.showAlarm('error', 'Network error removing product type.');
                }
            }

        } // end of class inventory app
        // Init App
        const app = new InventoryApp();

    </script>
</body>
</html>